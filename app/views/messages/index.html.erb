<% content_for :path do %><%='messages/' %>
<% end %>
<%if params[:to]
 a='?to='+params[:to] else a = '' end%>
<div id="mailbox">
<div id="mails">
  <div class="mtabs">
    <% if logged_in? %>
      <div class="mtabgap">&nbsp;</div>
      <%=link_to 'new', '/messages', class: a.length==0?'active':''%>
        <div class="mtabgap">&nbsp;</div>
      <%=link_to 'old', '/messages/?to='+current_user.name, class: a.length>0 && current_user.name==params[:to] ? 'active':'' %>
    <% end %>
        <div class="mtabgap">&nbsp;</div>
    <%=link_to 'chat', '/messages/?to=The Chat', class: a.length>0 && logged_in? && current_user.name!=params[:to] ? 'active':'' %>
      <div class="mtabgap">&nbsp;</div>
  </div>
  <% @messages.each do |message| %>
    <div class="maili">
      <b><%=link_to message.from, '/messages/'+message.id.to_s+a%></b>
      <span>
      <small>
        [<% if message.created_at < DateTime.now-1 %><%=space_time message.created_at.to_date%><% else %><%=message.created_at.to_time.to_s.split(' ')[1]%><% end %>]
      <br><b><%=message.subject.slice(0,24)%></b>
          <%=message.body.slice(0,24)%><%=message.body.length>24?'...':''%>
      </small></span>
    </div>
  <% end %>
</div>

<div id="mailbody">
  <span class="btn">
  <% if @fmessage %>
    <%=link_to 'reply', controller: 'messages', action: 'new',
      to: @fmessage.from,
        subject: 'RE: '+@fmessage.subject,
        body: sprintf(%{
----
from: %s
to: %s
date: %s
subject: %s
----
%s}, @fmessage.from, @fmessage.to, space_time(@fmessage.created_at.to_datetime), @fmessage.subject, @fmessage.body) %>
   <% end %>
  <%= link_to 'new message', '/messages/new'+a %>
  </span>

  <% if @fmessage %>
  <h3>from: <%=@fmessage.from%></h3>
  <h3>to: <%=@fmessage.to%></h3>
  <h3>date: <%=space_time @fmessage.created_at.to_datetime%></h3>
  <h2><%=@fmessage.subject%></h2>
  <p><% @fmessage.body.split("\n").map do |e| %>
      <%=e %>  <br/>
      <% end %>
    </p>

    <% if logged_in? %>
      <% if @fmessage.token_id %>
        <%=button_to "claim attached token", '/tokens/'+@fmessage.token_id.to_s,
         method: :patch  %>
      <%end%>
      <% if a.length==0 %>
        <%= button_to 'mark old', '/messages/'+@fmessage.id.to_s, method: :patch %>
      <% elsif current_user.name==params[:to]%>
        <%= button_to 'mark new', '/messages/'+@fmessage.id.to_s, method: :patch %>
      <% end %>
    <% end %>
  <% else %>
  <h2>no messages</h2>
  <% end %>

</div>
</div>
<script type="module">
renderer.flyTo="moon";
</script>
